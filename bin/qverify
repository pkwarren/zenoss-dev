#!/usr/bin/env python

# Verifies that the AMQP server is at least the minimum specified version. Uses
# the AMQP credentials stored in $ZENHOME/etc/global.conf.

import sys
from amqplib.client_0_8.connection import Connection

import Globals
from Products.ZenUtils.GlobalConfig import getGlobalConfiguration

if len(sys.argv) < 2:
    print >> sys.stderr, "Usage: qverify <version_number>"
    sys.exit(1)

expected_version = sys.argv[1]
global_conf = getGlobalConfiguration()
hostname = global_conf.get('amqphost', 'localhost')
port     = global_conf.get('amqpport', '5672')
username = global_conf.get('amqpuser', 'zenoss')
password = global_conf.get('amqppassword', 'zenoss')
vhost    = global_conf.get('amqpvhost', '/zenoss')
ssl      = global_conf.get('amqpusessl', '0')
use_ssl  = True if ssl in ('1', 'True', 'true') else False

conn = None
rc = 0
try:
    conn = Connection(host="%s:%s" % (hostname, port), userid=username,
                      password=password, virtual_host=vhost, ssl=use_ssl)
    server_version = conn.server_properties.get('version')
    e_ver = tuple(int(v) for v in expected_version.split('.'))
    s_ver = tuple(int(v) for v in server_version.split('.'))
    if s_ver < e_ver:
        print >> sys.stderr, "Server version: %s < Expected version: %s" % (
            server_version, expected_version)
        rc = 1
finally:
    if conn:
        conn.close()
    sys.exit(rc)
