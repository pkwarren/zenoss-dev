#!/bin/bash

set -e

# Rebuilds Zenoss (cleaning out any artifacts of previous build).

zenoss-clean
pushd $ZENSRC > /dev/null
if [ -d .svn ]; then
    svn-ignored | xargs rm -rf
    svn up
elif [ -d .git ]; then
    git svn rebase || :
    git clean -f -d -x
fi
pushd inst > /dev/null
link-products
time ./install.sh "$@"
find $ZENSRC -type f -a \( -name .build -o -name .extracted \) -exec rm -f {} \;
rm -rf $ZENSRC/inst/libzenoss
# Create Zope's __init__.py file for IntelliJ auto-completion to work properly
for d in Products zope; do
    touch $ZENHOME/lib/python/$d
done
make clean
zenoss stop || :
perl -pi -e 's/#    debug-mode on/debug-mode on/' $ZENHOME/etc/zope.conf
build-protocols
