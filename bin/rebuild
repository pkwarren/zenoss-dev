#!/bin/bash

set -e

# Rebuilds Zenoss (cleaning out any artifacts of previous build).

zenoss-clean
pushd $ZENSRC > /dev/null
if [ -d .svn ]; then
    svn-ignored | xargs rm -rf
    svn up
elif [ -d .git ]; then
    git svn rebase || :
    git clean -f -d -x
fi
pushd inst > /dev/null

link-products

if [ -x ./configure ]; then
    # Use new build process
    db='mysql'
    if [ "$USE_ZENDS" = "1" ]; then
        db='zends'
    fi
    set +e
    pkg-config --atleast-version 1.4.7 librrd
    if [ $? -ne 0 ]; then
        RRD_ARGS="--with-rrdtool=yes"
    fi
    set -e
    ./configure $RRD_ARGS --with-db=$db
    make -f zenoss.mk
    ./mkzenossinstance.sh
else
    time ./install.sh "$@"
fi

# Set the uid variable to the current user's username to avoid warnings
zenglobalconf -u uid=`id -un`

find $ZENSRC -type f -a \( -name .build -o -name .extracted \) -exec rm -f {} \;

rm -rf $ZENSRC/inst/libzenoss

# Create Zope's __init__.py file for IntelliJ auto-completion to work properly
for d in Products zope Shared Shared/DC; do
    if [ ! -f "$ZENHOME/lib/python/$d/__init__.py" ]; then
        echo "__import__('pkg_resources').declare_namespace(__name__)" > $ZENHOME/lib/python/$d/__init__.py
    fi
done

make clean

zenoss stop || :

perl -pi -e 's/#    debug-mode on/debug-mode on/' $ZENHOME/etc/zope.conf

build-protocols
